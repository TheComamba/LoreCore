name: Run Tests
on: [push]

jobs:
    build:
      strategy:
        fail-fast: false
        matrix:
          os: [ubuntu-latest, windows-latest, macos-latest]
      runs-on: ${{ matrix.os }}
      steps:
        - uses: actions/checkout@v3
  
        - name: Install dependencies for Linux
          if: matrix.os == 'ubuntu-latest'
          run: |
            sudo apt-get update
            sudo apt-get install -y curl build-essential cmake pkg-config libfontconfig1-dev
            ./scripts/install_build_dependencies_linux.sh
  
        - uses: dtolnay/rust-toolchain@stable@v1
          with:
              toolchain: stable
  
        - uses: actions-rs/cargo@v1
          if: ${{ github.ref_name != 'main' }}
          with:
              command: test
  
        - uses: actions-rs/cargo@v1
          if: ${{ github.ref_name == 'main' }}
          with:
              command: test
              args: --release